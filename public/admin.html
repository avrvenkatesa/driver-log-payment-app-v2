<!DOCTYPE html>
<html lang="en" data-language="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="adminPanel">Driver Log Pro - Admin Panel</title>
    <link rel="stylesheet" href="css/i18n.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-help {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-1px);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .config-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .config-value {
            font-weight: 600;
            color: #27ae60;
            font-size: 1.1em;
        }
        
        .history-timeline {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-timestamp {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .history-changes {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .history-change {
            display: block;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        
        .history-changed-by {
            font-size: 12px;
            color: #3498db;
            font-weight: 500;
        }
        
        .history-notes {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .impact-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .impact-significant {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .impact-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .impact-positive {
            color: #27ae60;
        }
        
        .impact-negative {
            color: #e74c3c;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                text-align: center;
            }
        }

        /* Story 14: Analytics Dashboard Styles */
        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            padding: 30px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .summary-card h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 500;
            opacity: 0.9;
        }

        .summary-card span {
            font-size: 32px;
            font-weight: 700;
            display: block;
        }

        .analytics-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }

        .filter-controls .btn-group {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filter-controls .btn {
            padding: 12px 20px;
            border: none;
            background: white;
            color: #495057;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-right: 1px solid #dee2e6;
        }

        .filter-controls .btn:last-child {
            border-right: none;
        }

        .filter-controls .btn:hover {
            background: #f8f9fa;
            color: #007bff;
        }

        .filter-controls .btn.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .refresh-controls .btn {
            padding: 10px 16px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-controls .btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .analytics-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .analytics-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .analytics-card .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px 25px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analytics-card .card-header h5 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #212529;
        }

        .period-desc {
            font-size: 14px;
            color: #6c757d;
            font-weight: 400;
        }

        .analytics-card .card-body {
            padding: 25px;
        }

        .chart-placeholder {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .driver-performance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .driver-performance-item:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .driver-info h6 {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .driver-info p {
            margin: 0;
            font-size: 14px;
            color: #6c757d;
        }

        .driver-metrics {
            text-align: right;
        }

        .driver-metrics .metric {
            font-size: 14px;
            color: #495057;
            margin-bottom: 3px;
        }

        .driver-metrics .metric strong {
            color: #212529;
        }

        .shifts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .shifts-table th,
        .shifts-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .shifts-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .shifts-table td {
            font-size: 14px;
            color: #212529;
        }

        .shifts-table tr:hover {
            background: #f8f9fa;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .pagination-controls .btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: #495057;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .pagination-controls .btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .pagination-controls .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Analytics Mobile Responsive */
        @media (max-width: 768px) {
            .analytics-summary { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
            .analytics-controls { flex-direction: column; align-items: stretch; }
            .analytics-content { grid-template-columns: 1fr; gap: 20px; }
            .filter-controls .btn { padding: 10px 15px; font-size: 14px; }
            .summary-card { padding: 20px 15px; }
            .summary-card span { font-size: 28px; }
        }

        @media (max-width: 480px) {
            .analytics-summary { grid-template-columns: 1fr 1fr; gap: 10px; }
            .summary-card { padding: 15px 10px; }
            .summary-card h4 { font-size: 14px; }
            .summary-card span { font-size: 24px; }
            .filter-controls .btn { padding: 8px 12px; font-size: 13px; }
            .driver-performance-item { flex-direction: column; text-align: center; }
            .driver-metrics { text-align: center; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 data-translate="adminPanel">🔧 Driver Log Pro - Admin Panel</h1>
                <div class="language-container">
                    <label for="languageSelector" data-translate="selectLanguage" style="font-size: 14px; color: #666; margin-right: 8px;">Select Language</label>
                    <select id="languageSelector" class="language-selector">
                        <option value="en" data-translate="english">English</option>
                        <option value="ta" data-translate="tamil">தமிழ்</option>
                    </select>
                </div>
            </div>
            <p class="subtitle" data-translate="systemStatus">System Configuration & Management</p>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('payroll')" data-translate="payrollConfig">💰 Payroll Config</button>
            <button class="nav-tab" onclick="showTab('drivers')" data-translate="driverManagement">👥 Driver Management</button>
            <button class="nav-tab" onclick="showTab('leave')" data-translate="leaveManagement">🏖️ Leave Management</button>
            <button class="nav-tab" onclick="showTab('advance')" data-translate="advanceMgmt">💳 Advance Payments</button>
            <button class="nav-tab" onclick="showTab('shifts')" data-translate="shiftManagement">⚙️ Shift Management</button>
            <button class="nav-tab" onclick="showTab('reports')" data-translate="reports">📊 Reports</button>
            <button class="nav-tab" onclick="showTab('system')" data-translate="settings">⚙️ System</button>
        </div>
        
        <!-- Alert Container -->
        <div id="alert-container"></div>
        
        <!-- Payroll Configuration Tab -->
        <div id="payroll-tab" class="tab-content active">
            <!-- Current Configuration Display -->
            <div class="card">
                <h3>💰 Current Payroll Configuration</h3>
                <div id="current-config-display" class="config-summary">
                    <div class="config-grid">
                        <div class="config-item">
                            <span class="config-label">Base Salary:</span>
                            <span class="config-value" id="current-salary">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Overtime Rate:</span>
                            <span class="config-value" id="current-overtime">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Fuel Allowance:</span>
                            <span class="config-value" id="current-fuel">Loading...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Working Hours:</span>
                            <span class="config-value" id="current-hours">Loading...</span>
                        </div>
                    </div>
                    <div class="config-last-changed" style="font-size: 0.9em; color: #666; font-style: italic; margin: 10px 0;">Last updated: Loading...</div>
                    <button id="edit-config-btn" class="btn-primary" onclick="showConfigForm()">⚙️ Edit Configuration</button>
                </div>
            </div>

            <!-- Configuration Form -->
            <div id="config-form-card" class="card" style="display: none;">
                <h3>⚙️ Update Payroll Configuration</h3>
                <form id="payroll-config-form">
                    <div class="form-group">
                        <label for="monthly_salary">Monthly Salary (₹) <span class="required">*</span></label>
                        <input type="number" id="monthly_salary" name="monthly_salary" min="1000" max="500000" step="0.01" required>
                        <small class="form-help">Range: ₹1,000 - ₹5,00,000</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="overtime_rate">Overtime Rate (₹/hour) <span class="required">*</span></label>
                        <input type="number" id="overtime_rate" name="overtime_rate" min="10" max="1000" step="0.01" required>
                        <small class="form-help">Range: ₹10 - ₹1,000 per hour</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="fuel_allowance">Fuel Allowance (₹/day) <span class="required">*</span></label>
                        <input type="number" id="fuel_allowance" name="fuel_allowance" min="1" max="500" step="0.01" required>
                        <small class="form-help">Range: ₹1 - ₹500 per day</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="working_hours">Working Hours/Day</label>
                        <input type="number" id="working_hours" name="working_hours" min="1" max="24" step="0.5" value="8">
                        <small class="form-help">Range: 1 - 24 hours per day</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes <span id="notes-required" class="required" style="display: none;">*</span></label>
                        <textarea id="notes" name="notes" placeholder="Reason for configuration change..." maxlength="500" rows="3"></textarea>
                        <small id="notes-help" class="form-help">Optional (max 500 characters)</small>
                    </div>
                    
                    <!-- Impact Analysis Display -->
                    <div id="impact-analysis" class="impact-analysis" style="display: none;">
                        <h4>Configuration Impact Analysis</h4>
                        <div id="impact-details"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="cancelConfigForm()">❌ Cancel</button>
                        <button type="button" class="btn-secondary" onclick="previewImpact()">🔍 Preview Impact</button>
                        <button type="submit" class="btn-primary">💾 Save Configuration</button>
                    </div>
                </form>
            </div>

            <!-- Configuration History -->
            <div class="card">
                <h3>📜 Configuration History</h3>
                <div id="config-history-section" class="config-history">
                    <div id="config-history-list" class="history-timeline">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading configuration history...
                        </div>
                    </div>
                    <button id="refresh-history-btn" class="btn-secondary" onclick="loadConfigHistory()">🔄 Refresh History</button>
                </div>
            </div>
        </div>
        
        <!-- Driver Management Tab -->
        <div id="drivers-tab" class="tab-content">
            <!-- Driver Summary Cards -->
            <div class="summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <div class="summary-card" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; opacity: 0.9;" data-translate="totalDrivers">Total Drivers</h4>
                    <span id="admin-total-drivers-count" style="font-size: 2.5em; font-weight: bold; display: block;">-</span>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; opacity: 0.9;" data-translate="activeDrivers">Active Drivers</h4>
                    <span id="admin-active-drivers-count" style="font-size: 2.5em; font-weight: bold; display: block;">-</span>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #f44336, #D32F2F); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; opacity: 0.9;" data-translate="inactiveDrivers">Inactive Drivers</h4>
                    <span id="admin-inactive-drivers-count" style="font-size: 2.5em; font-weight: bold; display: block;">-</span>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; opacity: 0.9;" data-translate="verifiedDrivers">Verified Drivers</h4>
                    <span id="admin-verified-drivers-count" style="font-size: 2.5em; font-weight: bold; display: block;">-</span>
                </div>
            </div>

            <div class="card">
                <h3>👥 Driver Management System</h3>
                
                <!-- Driver Management Controls -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="admin-driver-search" placeholder="Search drivers..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px;">
                        <select id="admin-driver-status-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">All Status</option>
                            <option value="active">Active Only</option>
                            <option value="inactive">Inactive Only</option>
                        </select>
                        <button onclick="searchAdminDrivers()" class="btn-primary" style="padding: 8px 16px;">🔍 Search</button>
                        <button onclick="clearAdminDriverSearch()" class="btn-secondary" style="padding: 8px 16px;">✖ Clear</button>
                    </div>
                    <button onclick="refreshAdminDriverList()" class="btn-primary" style="padding: 8px 16px;">🔄 Refresh</button>
                </div>

                <!-- Driver List Table -->
                <div style="overflow-x: auto; border: 1px solid #dee2e6; border-radius: 8px; background: white;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: 600;">ID</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: 600;">Name</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: 600;">Phone</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: 600;">Email</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: 600;">Metrics</th>
                                <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-driver-management-list">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                    <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                                    Loading drivers...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="admin-driver-pagination" style="display: none; margin-top: 20px; text-align: center;">
                    <button onclick="previousAdminDriverPage()" id="admin-driver-prev-btn" class="btn-secondary" style="margin-right: 10px;" disabled>← Previous</button>
                    <span id="admin-driver-page-info" style="margin: 0 15px; font-weight: 500;">Page 1 of 1</span>
                    <button onclick="nextAdminDriverPage()" id="admin-driver-next-btn" class="btn-secondary" style="margin-left: 10px;" disabled>Next →</button>
                </div>
            </div>
        </div>
        
        <!-- Leave Management Tab - Story 15: Admin Leave Management -->
        <div id="leave-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">🏖️ Leave Management</h2>
                    <p class="text-muted">Manage all driver leave requests</p>
                </div>
                <div class="card-body">
                    <!-- Leave Summary Cards -->
                    <div class="metrics-grid" id="leave-summary-cards" style="margin-bottom: 1.5rem;">
                        <div class="metric-card">
                            <div class="metric-icon">📋</div>
                            <div class="metric-value" id="total-requests">-</div>
                            <div class="metric-label">Total Requests</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">⏳</div>
                            <div class="metric-value" id="pending-requests">-</div>
                            <div class="metric-label">Pending</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">✅</div>
                            <div class="metric-value" id="approved-requests">-</div>
                            <div class="metric-label">Approved</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">❌</div>
                            <div class="metric-value" id="rejected-requests">-</div>
                            <div class="metric-label">Rejected</div>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="filter-controls" style="margin-bottom: 1rem; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <select id="leave-status-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <input type="date" id="leave-start-date" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="date" id="leave-end-date" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <button onclick="applyLeaveFilters()" class="btn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Apply Filters</button>
                        <button onclick="clearLeaveFilters()" class="btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Clear</button>
                        <button onclick="refreshLeaveData()" class="btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">🔄 Refresh</button>
                    </div>

                    <!-- Leave Requests Table -->
                    <div class="table-container" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <table class="data-table" id="leave-requests-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Driver</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Leave Date</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Type</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Reason</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Status</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Requested</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leave-requests-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                        <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                                        Loading leave requests...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container" id="leave-pagination" style="display: none; margin-top: 1rem; justify-content: space-between; align-items: center;">
                        <div class="pagination-info">
                            <span id="leave-page-info">-</span>
                        </div>
                        <div class="pagination-controls">
                            <button id="leave-prev" class="btn btn-sm" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer;" disabled>← Previous</button>
                            <button id="leave-next" class="btn btn-sm" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer;" disabled>Next →</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advance Payment Management Tab - Story 19: Advance Payment Management -->
        <div id="advance-tab" class="tab-content">
            <!-- Advance Payment Configuration Section -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2 class="card-title">⚙️ Advance Payment Configuration</h2>
                    <p class="text-muted">Configure advance payment limits and eligibility criteria</p>
                </div>
                <div class="card-body">
                    <!-- Current Configuration Display -->
                    <div id="advance-current-config" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                        <h4 style="margin: 0 0 15px 0; color: #007bff;">Current Configuration</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <strong>Max Advance %:</strong>
                                <span id="current-advance-percent">-</span>%
                            </div>
                            <div>
                                <strong>Monthly Requests:</strong>
                                <span id="current-monthly-requests">-</span>
                            </div>
                            <div>
                                <strong>Amount Range:</strong>
                                ₹<span id="current-min-amount">-</span> - ₹<span id="current-max-amount">-</span>
                            </div>
                            <div>
                                <strong>Eligibility:</strong>
                                <span id="current-eligibility-months">-</span> months
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            Last updated: <span id="config-last-updated">-</span>
                        </div>
                    </div>

                    <!-- Configuration Form -->
                    <div id="advance-config-form" style="display: none; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white;">
                        <h4 style="margin: 0 0 20px 0;">Update Configuration</h4>
                        <form id="advanceConfigForm">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Maximum Advance Percentage (%)</label>
                                    <input type="number" id="config-advance-percent" min="10" max="100" step="1" required
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <small style="color: #666;">10% - 100% of estimated monthly earnings</small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Max Monthly Requests</label>
                                    <input type="number" id="config-monthly-requests" min="1" max="12" step="1" required
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <small style="color: #666;">1 - 12 requests per month</small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Minimum Amount (₹)</label>
                                    <input type="number" id="config-min-amount" min="100" max="10000" step="100" required
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <small style="color: #666;">₹100 - ₹10,000</small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Maximum Amount (₹)</label>
                                    <input type="number" id="config-max-amount" min="1000" max="100000" step="1000" required
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <small style="color: #666;">₹1,000 - ₹1,00,000</small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Eligibility (Months)</label>
                                    <input type="number" id="config-eligibility-months" min="1" max="24" step="1" required
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <small style="color: #666;">1 - 24 months of employment</small>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Change Notes</label>
                                <textarea id="config-notes" rows="3" placeholder="Reason for configuration change..." required
                                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="cancelConfigEdit()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                                <button type="submit" id="config-submit-btn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Update Configuration</button>
                            </div>
                        </form>
                    </div>

                    <div style="margin-top: 15px;">
                        <button id="edit-config-btn" onclick="showConfigEditForm()" style="padding: 8px 16px; background: #ffc107; color: #212529; border: none; border-radius: 6px; cursor: pointer;">
                            ⚙️ Edit Configuration
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advance Payment Requests Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">💳 Advance Payment Requests</h2>
                    <p class="text-muted">Review, approve, and manage advance payment requests from drivers</p>
                </div>
                <div class="card-body">
                    <!-- Advance Payment Summary Cards -->
                    <div class="analytics-summary" style="margin-bottom: 30px;">
                        <div class="summary-card" style="background: linear-gradient(135deg, #ff9f43, #f37025); color: white;">
                            <h4>Pending Requests</h4>
                            <span id="pendingAdvancesCount">-</span>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #1dd1a1, #20bf6b); color: white;">
                            <h4>Approved This Month</h4>
                            <span id="approvedAdvancesCount">-</span>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #feca57, #ff9f43); color: white;">
                            <h4>Total Outstanding</h4>
                            <span id="totalOutstandingAmount">₹-</span>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #5f27cd, #8854d0); color: white;">
                            <h4>Average Request</h4>
                            <span id="averageRequestAmount">₹-</span>
                        </div>
                    </div>

                    <!-- Filter and Control Section -->
                    <div class="advance-controls" style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <select id="advance-status-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="paid">Paid</option>
                        </select>
                        <select id="advance-driver-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="all">All Drivers</option>
                        </select>
                        <input type="date" id="advance-from-date" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="date" id="advance-to-date" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <button onclick="applyAdvanceFilters()" class="btn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Apply Filters</button>
                        <button onclick="clearAdvanceFilters()" class="btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Clear</button>
                        <button onclick="refreshAdvanceData()" class="btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">🔄 Refresh</button>
                    </div>

                    <!-- Advance Requests Table -->
                    <div class="table-container" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <table class="data-table" id="advance-requests-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Driver</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Amount</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Type</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Request Date</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Reason</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Status</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="advance-requests-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                        <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                                        Loading advance requests...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container" id="advance-pagination" style="display: none; margin-top: 1rem; justify-content: space-between; align-items: center;">
                        <div class="pagination-info">
                            <span id="advance-page-info">-</span>
                        </div>
                        <div class="pagination-controls">
                            <button id="advance-prev" class="btn btn-sm" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer;" disabled>← Previous</button>
                            <button id="advance-next" class="btn btn-sm" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer;" disabled>Next →</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Shift Management Tab - Story 17: Manual Shift Management -->
        <div id="shifts-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">⚙️ Manual Shift Management</h2>
                    <p class="text-muted">Create, edit, and manage driver shifts manually</p>
                </div>
                <div class="card-body">
                    <!-- Shift Management Controls -->
                    <div class="shift-controls" style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <button onclick="showCreateShiftModal()" class="btn-primary" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ➕ Create New Shift
                        </button>
                        <select id="shift-driver-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="all">All Drivers</option>
                        </select>
                        <select id="shift-status-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                        <input type="date" id="shift-date-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <button onclick="applyShiftFilters()" class="btn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Apply Filters</button>
                        <button onclick="clearShiftFilters()" class="btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Clear</button>
                        <button onclick="refreshShiftData()" class="btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">🔄 Refresh</button>
                    </div>

                    <!-- Shifts Table -->
                    <div class="table-container" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <table class="data-table" id="shifts-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Driver</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Clock In</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Clock Out</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Duration</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Distance</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Status</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="shifts-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                        <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                                        Loading shifts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container" id="shifts-pagination" style="display: none; margin-top: 1rem; justify-content: space-between; align-items: center;">
                        <div class="pagination-info">
                            <span id="shifts-page-info">-</span>
                        </div>
                        <div class="pagination-controls">
                            <button id="shifts-prev" class="btn btn-sm" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer;" disabled>← Previous</button>
                            <button id="shifts-next" class="btn btn-sm" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer;" disabled>Next →</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab - Story 14: Shift Analytics -->
        <div id="reports-tab" class="tab-content">
            <!-- Analytics Summary Cards -->
            <div class="analytics-summary">
                <div class="summary-card" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                    <h4>Total Shifts</h4>
                    <span id="totalShiftsCount">-</span>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #27ae60, #229954); color: white;">
                    <h4>Total Distance</h4>
                    <span id="totalDistanceCount">- km</span>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white;">
                    <h4>Total Hours</h4>
                    <span id="totalHoursCount">- hrs</span>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">
                    <h4>Active Drivers</h4>
                    <span id="activeDriversCount">-</span>
                </div>
            </div>

            <!-- PDF Payroll Export Section (Story 18) -->
            <div class="card" style="margin-bottom: 25px;">
                <h3>📋 Payroll Reports & PDF Export</h3>
                <p style="color: #666; margin-bottom: 20px;">Generate professional payroll reports in PDF format for monthly and yearly periods.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px;">
                    <!-- Monthly Report -->
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; background: #fafafa;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">📅 Monthly Payroll Report</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Generate detailed payroll report for a specific month with driver breakdown.</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Year</label>
                                <select id="monthly-year" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Month</label>
                                <select id="monthly-month" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7" selected>July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="generateMonthlyPDF()" class="btn-primary" style="flex: 1; padding: 10px; font-size: 14px;">
                                📄 Generate PDF
                            </button>
                            <button onclick="previewMonthlyReport()" class="btn btn-secondary" style="padding: 10px 15px; font-size: 14px;">
                                👁️ Preview
                            </button>
                        </div>
                    </div>
                    
                    <!-- Year-to-Date Report -->
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; background: #fafafa;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">📊 Year-to-Date Report</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Generate comprehensive annual payroll summary with monthly breakdown.</p>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Year</label>
                            <select id="ytd-year" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="generateYTDPDF()" class="btn-primary" style="flex: 1; padding: 10px; font-size: 14px;">
                                📊 Generate YTD PDF
                            </button>
                            <button onclick="previewYTDReport()" class="btn btn-secondary" style="padding: 10px 15px; font-size: 14px;">
                                👁️ Preview
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Export Status -->
                <div id="pdf-export-status" style="display: none; padding: 15px; border-radius: 6px; margin-top: 15px;">
                    <div style="display: flex; align-items: center;">
                        <div class="loading-spinner" style="width: 20px; height: 20px; margin-right: 10px;"></div>
                        <span id="pdf-status-text">Generating PDF report...</span>
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="card">
                <div class="analytics-controls">
                    <div class="filter-controls">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-filter="today">Today</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="week">This Week</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="month">This Month</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="all">All Time</button>
                        </div>
                    </div>
                    <div class="refresh-controls">
                        <button id="refreshAnalytics" class="btn btn-secondary">
                            🔄 Refresh
                        </button>
                        <small id="lastUpdated" class="text-muted">Last updated: -</small>
                    </div>
                </div>
            </div>

            <!-- Analytics Content -->
            <div class="analytics-content">
                <!-- Trends Chart -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h5>📈 Shift Trends</h5>
                        <span id="period-description" class="period-desc">Loading...</span>
                    </div>
                    <div class="card-body">
                        <div id="trends-chart">
                            <div class="chart-placeholder">
                                <div class="loading-spinner"></div>
                                <p>Loading analytics data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Driver Performance -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h5>👥 Driver Performance</h5>
                    </div>
                    <div class="card-body">
                        <div id="driverPerformanceList">
                            <div class="loading-spinner"></div>
                            <p>Loading performance data...</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Shifts -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h5>🚛 Recent Shifts</h5>
                    </div>
                    <div class="card-body">
                        <div id="recent-shifts-table">
                            <div class="loading-spinner"></div>
                            <p>Loading shift data...</p>
                        </div>
                        <!-- Pagination -->
                        <div id="analytics-pagination" class="pagination-container" style="display: none;">
                            <div class="pagination-info">
                                <span id="analytics-page-info">-</span>
                            </div>
                            <div class="pagination-controls">
                                <button id="analytics-prev" class="btn btn-sm btn-secondary">← Previous</button>
                                <button id="analytics-next" class="btn btn-sm btn-secondary">Next →</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="system-tab" class="tab-content">
            <div class="card">
                <h3>⚙️ System Settings</h3>
                <p>System configuration options will be implemented in future stories.</p>
            </div>
        </div>
    </div>

    <!-- Shift Management Modal -->
    <div id="shift-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-title">Create New Shift</h3>
                <button onclick="closeShiftModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">✕</button>
            </div>
            
            <form id="shift-form">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Driver</label>
                    <select id="shift-driver-select" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">Select Driver</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Clock In Time</label>
                        <input type="datetime-local" id="shift-clock-in" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Clock Out Time</label>
                        <input type="datetime-local" id="shift-clock-out" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <small style="color: #666; font-size: 12px;">Leave empty for active shift</small>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Start Odometer</label>
                        <input type="number" id="shift-start-odo" required min="0" step="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">End Odometer</label>
                        <input type="number" id="shift-end-odo" min="0" step="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <small style="color: #666; font-size: 12px;">Leave empty for active shift</small>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
                    <textarea id="shift-notes" placeholder="Manual shift creation reason (required)" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeShiftModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" id="shift-submit-btn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">Create Shift</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('driverToken');
        let currentConfig = {};
        
        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loading...');
            
            if (!authToken) {
                showAlert('Please login first', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }
            
            // RBAC: Check if user is admin before allowing access
            const userRole = getUserRoleFromToken();
            if (userRole !== 'admin') {
                showAlert('Access denied. Admin privileges required to access this panel.', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
                return;
            }
            
            console.log('[RBAC] Admin access granted for user with role:', userRole);
            loadCurrentConfig();
            loadConfigHistory();
            
            // Initialize all data sources
            initializeAllData();
        });
        
        // Initialize all data sources
        async function initializeAllData() {
            try {
                console.log('[Admin Panel] Initializing all data sources...');
                
                // Load drivers data first (used by multiple tabs)
                if (typeof loadAdminDriverManagement === 'function') {
                    await loadAdminDriverManagement();
                }
                
                // Load shift management data
                if (typeof loadShiftManagement === 'function') {
                    await loadShiftManagement();
                }
                
                // Load analytics data - initialize first
                if (typeof initializeAnalyticsDashboard === 'function') {
                    await initializeAnalyticsDashboard();
                }
                
                // Load advance payment data
                if (typeof refreshAdvanceData === 'function') {
                    await refreshAdvanceData();
                }
                
                // Load advance payment configuration
                if (typeof loadAdvanceConfig === 'function') {
                    await loadAdvanceConfig();
                }
                
                // Load leave management data
                if (typeof refreshLeaveData === 'function') {
                    await refreshLeaveData();
                }
                
                console.log('[Admin Panel] All data sources initialized successfully');
                
            } catch (error) {
                console.error('[Admin Panel] Error initializing data sources:', error);
                showAlert('Some data may not load properly. Please refresh the page.', 'warning');
            }
        }
        
        // Tab navigation - removed since we have the enhanced version below
        
        // Load current payroll configuration
        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/admin/payroll-config', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentConfig = result.data;
                    displayCurrentConfig(result.data);
                } else {
                    showAlert(`Failed to load configuration: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error loading current config:', error);
                showAlert('Failed to load current configuration', 'error');
            }
        }
        
        // Display current configuration
        function displayCurrentConfig(config) {
            document.getElementById('current-salary').textContent = `₹${config.monthly_salary.toLocaleString()}/month`;
            document.getElementById('current-overtime').textContent = `₹${config.overtime_rate}/hour`;
            document.getElementById('current-fuel').textContent = `₹${config.fuel_allowance}/day`;
            document.getElementById('current-hours').textContent = `${config.working_hours} hours/day`;
            
            // Update last changed timestamp in IST
            if (config.changed_at) {
                const lastChangedElement = document.querySelector('.config-last-changed');
                if (lastChangedElement) {
                    lastChangedElement.textContent = `Last updated: ${convertToIST(config.changed_at)}`;
                }
            }
        }
        
        // Show configuration form
        function showConfigForm() {
            document.getElementById('config-form-card').style.display = 'block';
            
            // Pre-fill form with current values
            document.getElementById('monthly_salary').value = currentConfig.monthly_salary;
            document.getElementById('overtime_rate').value = currentConfig.overtime_rate;
            document.getElementById('fuel_allowance').value = currentConfig.fuel_allowance;
            document.getElementById('working_hours').value = currentConfig.working_hours;
            document.getElementById('notes').value = '';
            
            // Hide impact analysis
            document.getElementById('impact-analysis').style.display = 'none';
            
            // Reset notes field validation
            updateNotesValidation(false);
            
            // Add change listeners to form fields
            addFormChangeListeners();
            
            // Scroll to form
            document.getElementById('config-form-card').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Cancel configuration form
        function cancelConfigForm() {
            document.getElementById('config-form-card').style.display = 'none';
        }
        
        // Preview configuration impact
        async function previewImpact() {
            try {
                const formData = new FormData(document.getElementById('payroll-config-form'));
                const configData = Object.fromEntries(formData);
                
                const response = await fetch('/api/admin/payroll-config/impact', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayImpactAnalysis(result.data);
                } else {
                    showAlert(`Failed to calculate impact: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error calculating impact:', error);
                showAlert('Failed to calculate configuration impact', 'error');
            }
        }
        
        // Display impact analysis
        function displayImpactAnalysis(impact) {
            const container = document.getElementById('impact-analysis');
            const details = document.getElementById('impact-details');
            
            let html = '';
            
            if (impact.salary) {
                const changeClass = impact.salary.change >= 0 ? 'impact-positive' : 'impact-negative';
                html += `
                    <div class="impact-item">
                        <span>Salary Change:</span>
                        <span class="${changeClass}">₹${impact.salary.change} (${impact.salary.changePercent}%)</span>
                    </div>
                `;
            }
            
            if (impact.overtime) {
                const changeClass = impact.overtime.change >= 0 ? 'impact-positive' : 'impact-negative';
                html += `
                    <div class="impact-item">
                        <span>Overtime Rate Change:</span>
                        <span class="${changeClass}">₹${impact.overtime.change} (${impact.overtime.changePercent}%)</span>
                    </div>
                `;
            }
            
            if (impact.fuel) {
                const changeClass = impact.fuel.change >= 0 ? 'impact-positive' : 'impact-negative';
                html += `
                    <div class="impact-item">
                        <span>Fuel Allowance Change:</span>
                        <span class="${changeClass}">₹${impact.fuel.change.toFixed(2)} (${impact.fuel.changePercent}%)</span>
                    </div>
                `;
            }
            
            if (impact.overallSignificant) {
                container.classList.add('impact-significant');
                html += '<div style="margin-top: 10px; font-weight: bold; color: #721c24;">⚠️ Significant changes detected (>20%)</div>';
            } else {
                container.classList.remove('impact-significant');
            }
            
            details.innerHTML = html;
            container.style.display = 'block';
        }
        
        // Add form change listeners to detect configuration changes
        function addFormChangeListeners() {
            const fields = ['monthly_salary', 'overtime_rate', 'fuel_allowance', 'working_hours'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', checkForChanges);
                field.addEventListener('change', checkForChanges);
            });
        }
        
        // Check if form values have changed from current config
        function checkForChanges() {
            if (!currentConfig) return;
            
            const formSalary = parseFloat(document.getElementById('monthly_salary').value) || 0;
            const formOvertime = parseFloat(document.getElementById('overtime_rate').value) || 0;
            const formFuel = parseFloat(document.getElementById('fuel_allowance').value) || 0;
            const formHours = parseFloat(document.getElementById('working_hours').value) || 8;
            
            const hasChanges = 
                formSalary !== currentConfig.monthly_salary ||
                formOvertime !== currentConfig.overtime_rate ||
                formFuel !== currentConfig.fuel_allowance ||
                formHours !== currentConfig.working_hours;
            
            updateNotesValidation(hasChanges);
        }
        
        // Update notes field validation based on whether changes are detected
        function updateNotesValidation(hasChanges) {
            const notesField = document.getElementById('notes');
            const notesRequired = document.getElementById('notes-required');
            const notesHelp = document.getElementById('notes-help');
            
            if (hasChanges) {
                notesField.required = true;
                notesRequired.style.display = 'inline';
                notesHelp.textContent = 'Required when making changes (max 500 characters)';
                notesHelp.style.color = '#e74c3c';
                notesField.style.borderColor = '#e74c3c';
            } else {
                notesField.required = false;
                notesRequired.style.display = 'none';
                notesHelp.textContent = 'Optional (max 500 characters)';
                notesHelp.style.color = '#7f8c8d';
                notesField.style.borderColor = '#ddd';
            }
        }
        
        // Handle form submission
        document.getElementById('payroll-config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const configData = Object.fromEntries(formData);
                
                // Client-side validation for changes and notes
                const hasChanges = 
                    parseFloat(configData.monthly_salary) !== currentConfig.monthly_salary ||
                    parseFloat(configData.overtime_rate) !== currentConfig.overtime_rate ||
                    parseFloat(configData.fuel_allowance) !== currentConfig.fuel_allowance ||
                    parseFloat(configData.working_hours || 8) !== currentConfig.working_hours;
                
                if (hasChanges && (!configData.notes || configData.notes.trim().length === 0)) {
                    showAlert('Configuration changes detected. Please provide a reason in the notes field.', 'error');
                    document.getElementById('notes').focus();
                    return;
                }
                
                const response = await fetch('/api/admin/payroll-config', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showAlert('Configuration saved successfully!', 'success');
                    currentConfig = result.data;
                    displayCurrentConfig(result.data);
                    cancelConfigForm();
                    loadConfigHistory();
                } else {
                    showAlert(`Failed to save configuration: ${result.error || result.details}`, 'error');
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showAlert('Failed to save configuration', 'error');
            }
        });
        
        // Load configuration history
        async function loadConfigHistory() {
            try {
                const response = await fetch('/api/admin/payroll-config-history?limit=20', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayConfigHistory(result.data);
                } else {
                    showAlert(`Failed to load history: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error loading config history:', error);
                showAlert('Failed to load configuration history', 'error');
            }
        }
        
        // Convert UTC timestamp to IST (Indian Standard Time)
        function convertToIST(utcTimestamp) {
            const utcDate = new Date(utcTimestamp);
            
            // Use proper timezone conversion with Intl.DateTimeFormat
            const options = {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            
            const formatter = new Intl.DateTimeFormat('en-IN', options);
            const formattedDate = formatter.format(utcDate);
            
            // Add IST suffix for clarity
            return formattedDate + ' IST';
        }
        
        // Display configuration history
        function displayConfigHistory(history) {
            const container = document.getElementById('config-history-list');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="loading">No configuration history found</div>';
                return;
            }
            
            const historyHtml = history.map(item => `
                <div class="history-item">
                    <div class="history-timestamp">${item.changed_at} IST</div>
                    <div class="history-changes">
                        <span class="history-change">Salary: ₹${item.monthly_salary.toLocaleString()}</span>
                        <span class="history-change">Overtime: ₹${item.overtime_rate}/hour</span>
                        <span class="history-change">Fuel: ₹${item.fuel_allowance}/day</span>
                        <span class="history-change">Hours: ${item.working_hours}/day</span>
                    </div>
                    <div class="history-changed-by">Changed by: ${item.changed_by}</div>
                    ${item.notes ? `<div class="history-notes">"${item.notes}"</div>` : ''}
                </div>
            `).join('');
            
            container.innerHTML = historyHtml;
        }
        
        // Show alert messages
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            container.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                    <button style="float: right; background: none; border: none; font-size: 16px; cursor: pointer;" onclick="this.parentElement.remove()">×</button>
                </div>
            `;
            
            // Auto-remove success alerts after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    const alert = container.querySelector('.alert');
                    if (alert) alert.remove();
                }, 5000);
            }
        }
        
        // RBAC: Extract user role from JWT token
        function getUserRoleFromToken() {
            if (!authToken) return 'driver';
            
            try {
                const tokenParts = authToken.split('.');
                if (tokenParts.length !== 3) return 'driver';
                
                const payload = JSON.parse(atob(tokenParts[1]));
                return payload.role || 'driver';
            } catch (error) {
                console.error('[RBAC] Error parsing token:', error);
                return 'driver';
            }
        }

        // Admin Driver Management Variables
        let adminCurrentDriverPage = 1;
        let adminTotalDriverPages = 1;
        let adminDriverSearchTerm = '';
        let adminDriverStatusFilter = '';

        // Load admin driver management when drivers tab is selected
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Load data when specific tabs are selected
            if (tabName === 'drivers') {
                loadAdminDriverManagement();
            } else if (tabName === 'reports') {
                loadReportsAnalytics();
            }
        }

        // Load admin driver management
        async function loadAdminDriverManagement() {
            console.log('[Admin Driver Management] Loading drivers...');
            
            try {
                const response = await fetch(`/api/admin/drivers?page=${adminCurrentDriverPage}&limit=10&search=${encodeURIComponent(adminDriverSearchTerm)}&status=${adminDriverStatusFilter}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                console.log('[Admin Driver Management] API Response:', result);
                
                if (result.success) {
                    displayAdminDriverList(result.data.drivers, result.data.pagination);
                    updateAdminDriverSummary(result.data.summary);
                } else {
                    throw new Error(result.message || 'Failed to load drivers');
                }
                
            } catch (error) {
                console.error('[Admin Driver Management] Error:', error);
                document.getElementById('admin-driver-management-list').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">
                            ❌ Error loading drivers: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Display admin driver list
        function displayAdminDriverList(drivers, pagination) {
            const tbody = document.getElementById('admin-driver-management-list');
            
            if (!drivers || drivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            📭 No drivers found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = drivers.map(driver => {
                const status = driver.status || 'inactive';
                const statusColor = status === 'active' ? '#28a745' : '#dc3545';
                const statusBadge = `<span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${status.toUpperCase()}</span>`;
                
                return `
                    <tr>
                        <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6; font-weight: 500;">${driver.id}</td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6; font-weight: 500;">${driver.name}</td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6;">${driver.phone || 'N/A'}</td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6;">${driver.email || 'N/A'}</td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6;">${statusBadge}</td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6;">
                            <div style="font-size: 12px; line-height: 1.4;">
                                <div><strong>${driver.metrics?.totalShifts || 0}</strong> shifts</div>
                                <div><strong>${driver.metrics?.totalHours || 0}</strong> hours</div>
                                <div><strong>${driver.metrics?.totalDistance || 0}</strong> km</div>
                            </div>
                        </td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6;">
                            <button onclick="toggleAdminDriverStatus(${driver.id}, '${status}')" class="btn-primary" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">
                                ${status === 'active' ? '🔒 Deactivate' : '✅ Activate'}
                            </button>
                            <button onclick="viewAdminDriverDetails(${driver.id})" class="btn-secondary" style="padding: 4px 8px; font-size: 12px;">👁 View</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update pagination
            updateAdminDriverPagination(pagination);
        }

        // Update admin driver summary cards
        function updateAdminDriverSummary(summary) {
            console.log('[Admin Driver Management] Updating summary cards:', summary);
            
            if (summary) {
                document.getElementById('admin-total-drivers-count').textContent = summary.totalDrivers || 0;
                document.getElementById('admin-active-drivers-count').textContent = summary.activeDrivers || 0;
                document.getElementById('admin-inactive-drivers-count').textContent = summary.inactiveDrivers || 0;
                document.getElementById('admin-verified-drivers-count').textContent = summary.verifiedDrivers || 0;
            }
        }

        // Update admin driver pagination
        function updateAdminDriverPagination(pagination) {
            adminTotalDriverPages = pagination.totalPages || 1;
            adminCurrentDriverPage = pagination.page || 1;
            
            document.getElementById('admin-driver-page-info').textContent = 
                `Page ${adminCurrentDriverPage} of ${adminTotalDriverPages} (${pagination.total} drivers)`;
            
            document.getElementById('admin-driver-prev-btn').disabled = !pagination.hasPrev;
            document.getElementById('admin-driver-next-btn').disabled = !pagination.hasNext;
            
            document.getElementById('admin-driver-pagination').style.display = 
                adminTotalDriverPages > 1 ? 'flex' : 'none';
        }

        // Admin driver search
        function searchAdminDrivers() {
            adminDriverSearchTerm = document.getElementById('admin-driver-search').value.trim();
            adminDriverStatusFilter = document.getElementById('admin-driver-status-filter').value;
            adminCurrentDriverPage = 1;
            loadAdminDriverManagement();
        }

        // Clear admin driver search
        function clearAdminDriverSearch() {
            document.getElementById('admin-driver-search').value = '';
            document.getElementById('admin-driver-status-filter').value = '';
            adminDriverSearchTerm = '';
            adminDriverStatusFilter = '';
            adminCurrentDriverPage = 1;
            loadAdminDriverManagement();
        }

        // Refresh admin driver list
        function refreshAdminDriverList() {
            loadAdminDriverManagement();
        }

        // Previous admin driver page
        function previousAdminDriverPage() {
            if (adminCurrentDriverPage > 1) {
                adminCurrentDriverPage--;
                loadAdminDriverManagement();
            }
        }

        // Next admin driver page
        function nextAdminDriverPage() {
            if (adminCurrentDriverPage < adminTotalDriverPages) {
                adminCurrentDriverPage++;
                loadAdminDriverManagement();
            }
        }

        // Toggle admin driver status
        async function toggleAdminDriverStatus(driverId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';
            
            if (!confirm(`Are you sure you want to ${action} this driver?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/drivers/${driverId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Driver ${action}d successfully!`, 'success');
                    loadAdminDriverManagement();
                } else {
                    throw new Error(result.message || `Failed to ${action} driver`);
                }
                
            } catch (error) {
                console.error(`[Admin Driver Management] Error ${action}ing driver:`, error);
                showAlert(`Error ${action}ing driver: ${error.message}`, 'error');
            }
        }

        // View admin driver details
        function viewAdminDriverDetails(driverId) {
            alert(`Driver details for ID ${driverId} - Feature coming soon!`);
        }

        // Story 14: Analytics Dashboard Implementation
        let analyticsCurrentFilter = 'today';
        let analyticsCurrentPage = 1;
        let analyticsPageSize = 10;
        const analytics = {
            summary: {
                totalShifts: 0,
                totalDistance: 0,
                totalHours: 0,
                activeDrivers: 0
            },
            trends: [],
            drivers: [],
            recentShifts: []
        };

        // Initialize analytics dashboard
        async function initializeAnalyticsDashboard() {
            console.log('[Analytics] Initializing analytics dashboard...');
            
            // Setup filter button event listeners
            const filterButtons = document.querySelectorAll('.filter-controls .btn');
            console.log(`[Analytics] Found ${filterButtons.length} filter buttons`);
            
            filterButtons.forEach((btn, index) => {
                console.log(`[Analytics] Setting up button ${index}: ${btn.textContent} (filter: ${btn.dataset.filter})`);
                btn.addEventListener('click', handleFilterChange);
            });
            
            // Setup refresh button
            const refreshBtn = document.getElementById('refreshAnalytics');
            if (refreshBtn) {
                console.log('[Analytics] Refresh button found and event listener attached');
                refreshBtn.addEventListener('click', refreshAnalytics);
            } else {
                console.log('[Analytics] Refresh button not found');
            }
            
            // Setup pagination
            const prevBtn = document.getElementById('analytics-prev');
            const nextBtn = document.getElementById('analytics-next');
            if (prevBtn) {
                console.log('[Analytics] Previous button found and event listener attached');
                prevBtn.addEventListener('click', previousAnalyticsPage);
            }
            if (nextBtn) {
                console.log('[Analytics] Next button found and event listener attached');
                nextBtn.addEventListener('click', nextAnalyticsPage);
            }
            
            // Load initial data
            console.log('[Analytics] Loading initial analytics data...');
            await loadAnalyticsData();
            
            console.log('[Analytics] Analytics dashboard initialized successfully');
        }

        // Handle filter change
        function handleFilterChange(event) {
            event.preventDefault();
            const newFilter = event.target.dataset.filter;
            
            console.log(`[Analytics] Filter changed to: ${newFilter}`);
            
            // Update active button
            document.querySelectorAll('.filter-controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update filter and reload data
            analyticsCurrentFilter = newFilter;
            analyticsCurrentPage = 1;
            
            console.log(`[Analytics] Loading data for filter: ${newFilter}`);
            loadAnalyticsData();
        }

        // Load analytics data from API
        async function loadAnalyticsData() {
            console.log(`[Analytics] Loading analytics data for filter: ${analyticsCurrentFilter}`);
            
            try {
                showAnalyticsLoading(true);
                
                // Fetch analytics data from the API
                const response = await fetch(`/api/admin/analytics?filter=${analyticsCurrentFilter}&page=${analyticsCurrentPage}&limit=${analyticsPageSize}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    analytics.summary = result.data.summary;
                    analytics.trends = result.data.trends || [];
                    analytics.drivers = result.data.drivers || [];
                    analytics.recentShifts = result.data.recentShifts || [];
                    
                    // Update UI components
                    updateSummaryCards();
                    updateTrendsChart();
                    updateDriverPerformance();
                    updateRecentShifts();
                    updateLastUpdated();
                    
                    console.log('[Analytics] Analytics data loaded successfully:', result.data);
                } else {
                    throw new Error(result.error || 'Failed to load analytics data');
                }
                
            } catch (error) {
                console.error('[Analytics] Error loading analytics data:', error);
                showAnalyticsError(error.message);
            } finally {
                showAnalyticsLoading(false);
            }
        }

        // Update summary cards
        function updateSummaryCards() {
            document.getElementById('totalShiftsCount').textContent = analytics.summary.totalShifts || 0;
            document.getElementById('totalDistanceCount').textContent = `${(analytics.summary.totalDistance || 0).toFixed(1)} km`;
            document.getElementById('totalHoursCount').textContent = `${(analytics.summary.totalHours || 0).toFixed(1)} hrs`;
            document.getElementById('activeDriversCount').textContent = analytics.summary.activeDrivers || 0;
        }

        // Update trends chart (simplified text-based visualization)
        function updateTrendsChart() {
            const chartContainer = document.getElementById('trends-chart');
            const periodDesc = document.getElementById('period-description');
            
            // Update period description
            const periodTexts = {
                today: `Today (${new Date().toLocaleDateString('en-IN')})`,
                week: `This Week (${getWeekRange()})`,
                month: `This Month (${new Date().toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })})`,
                all: 'All Time Data'
            };
            
            periodDesc.textContent = periodTexts[analyticsCurrentFilter] || 'Loading...';
            
            // Create simple trend visualization
            if (analytics.trends.length > 0) {
                const trendsHtml = `
                    <div class="trends-visualization">
                        <h6>📊 Shift Distribution</h6>
                        ${analytics.trends.map(trend => `
                            <div class="trend-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <span>${trend.period}</span>
                                <span><strong>${trend.shifts} shifts</strong> | ${trend.hours}h | ${trend.distance}km</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                chartContainer.innerHTML = trendsHtml;
            } else {
                chartContainer.innerHTML = `
                    <div class="chart-placeholder">
                        <p>No trend data available for the selected period</p>
                    </div>
                `;
            }
        }

        // Update driver performance
        function updateDriverPerformance() {
            const container = document.getElementById('driverPerformanceList');
            
            if (analytics.drivers.length > 0) {
                const driversHtml = analytics.drivers.map(driver => `
                    <div class="driver-performance-item">
                        <div class="driver-info">
                            <h6>${driver.name}</h6>
                            <p>Phone: ${driver.phone}</p>
                        </div>
                        <div class="driver-metrics">
                            <div class="metric">Shifts: <strong>${driver.shifts}</strong></div>
                            <div class="metric">Hours: <strong>${driver.hours}h</strong></div>
                            <div class="metric">Distance: <strong>${driver.distance}km</strong></div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = driversHtml;
            } else {
                container.innerHTML = `
                    <div class="chart-placeholder">
                        <p>No driver performance data available</p>
                    </div>
                `;
            }
        }

        // Update recent shifts table
        function updateRecentShifts() {
            const container = document.getElementById('recent-shifts-table');
            const paginationContainer = document.getElementById('analytics-pagination');
            
            if (analytics.recentShifts.length > 0) {
                const shiftsHtml = `
                    <table class="shifts-table">
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Date</th>
                                <th>Duration</th>
                                <th>Distance</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analytics.recentShifts.map(shift => `
                                <tr>
                                    <td>${shift.driverName}</td>
                                    <td>${new Date(shift.clockInTime).toLocaleDateString('en-IN')}</td>
                                    <td>${shift.duration} min</td>
                                    <td>${shift.distance} km</td>
                                    <td><span class="status-badge status-${shift.status}">${shift.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = shiftsHtml;
                
                // Show pagination if needed
                if (analytics.summary.totalShifts > analyticsPageSize) {
                    paginationContainer.style.display = 'flex';
                    updateAnalyticsPagination();
                } else {
                    paginationContainer.style.display = 'none';
                }
            } else {
                container.innerHTML = `
                    <div class="chart-placeholder">
                        <p>No recent shifts available</p>
                    </div>
                `;
                paginationContainer.style.display = 'none';
            }
        }

        // Update analytics pagination
        function updateAnalyticsPagination() {
            const totalPages = Math.ceil(analytics.summary.totalShifts / analyticsPageSize);
            const pageInfo = document.getElementById('analytics-page-info');
            const prevBtn = document.getElementById('analytics-prev');
            const nextBtn = document.getElementById('analytics-next');
            
            pageInfo.textContent = `Page ${analyticsCurrentPage} of ${totalPages} (${analytics.summary.totalShifts} total shifts)`;
            
            prevBtn.disabled = analyticsCurrentPage <= 1;
            nextBtn.disabled = analyticsCurrentPage >= totalPages;
        }

        // Previous analytics page
        function previousAnalyticsPage() {
            if (analyticsCurrentPage > 1) {
                analyticsCurrentPage--;
                loadAnalyticsData();
            }
        }

        // Next analytics page
        function nextAnalyticsPage() {
            const totalPages = Math.ceil(analytics.summary.totalShifts / analyticsPageSize);
            if (analyticsCurrentPage < totalPages) {
                analyticsCurrentPage++;
                loadAnalyticsData();
            }
        }

        // Refresh analytics data
        function refreshAnalytics() {
            console.log('[Analytics] Refreshing analytics data...');
            loadAnalyticsData();
        }

        // Show analytics loading state
        function showAnalyticsLoading(show) {
            const loadingElements = [
                'trends-chart',
                'driverPerformanceList',
                'recent-shifts-table'
            ];
            
            loadingElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (show) {
                    element.innerHTML = `
                        <div class="chart-placeholder">
                            <div class="loading-spinner"></div>
                            <p>Loading data...</p>
                        </div>
                    `;
                }
            });
        }

        // Show analytics error
        function showAnalyticsError(message) {
            const errorElements = [
                'trends-chart',
                'driverPerformanceList',
                'recent-shifts-table'
            ];
            
            errorElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                element.innerHTML = `
                    <div class="chart-placeholder">
                        <p style="color: #e74c3c;">Error: ${message}</p>
                        <button onclick="refreshAnalytics()" class="btn btn-secondary btn-sm">Try Again</button>
                    </div>
                `;
            });
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const timestamp = new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            document.getElementById('lastUpdated').textContent = `Last updated: ${timestamp} IST`;
        }

        // Get week range for display
        function getWeekRange() {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            
            return `${startOfWeek.toLocaleDateString('en-IN')} - ${endOfWeek.toLocaleDateString('en-IN')}`;
        }

        // Load analytics data for Reports tab
        async function loadReportsAnalytics() {
            console.log('[Reports Analytics] Loading analytics data for Reports tab...');
            
            try {
                // Show loading state
                document.getElementById('totalShiftsCount').textContent = '...';
                document.getElementById('totalDistanceCount').textContent = '... km';
                document.getElementById('totalHoursCount').textContent = '... hrs';
                document.getElementById('activeDriversCount').textContent = '...';
                
                // Fetch analytics data from the API
                const response = await fetch('/api/admin/analytics?filter=all', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const summary = result.data.summary;
                    
                    // Update the analytics cards
                    document.getElementById('totalShiftsCount').textContent = summary.totalShifts || 0;
                    document.getElementById('totalDistanceCount').textContent = `${(summary.totalDistance || 0).toFixed(1)} km`;
                    document.getElementById('totalHoursCount').textContent = `${(summary.totalHours || 0).toFixed(1)} hrs`;
                    document.getElementById('activeDriversCount').textContent = summary.activeDrivers || 0;
                    
                    console.log('[Reports Analytics] Analytics cards updated successfully:', summary);
                } else {
                    throw new Error(result.error || 'Failed to load analytics data');
                }
                
            } catch (error) {
                console.error('[Reports Analytics] Error loading analytics data:', error);
                
                // Show error state
                document.getElementById('totalShiftsCount').textContent = 'Error';
                document.getElementById('totalDistanceCount').textContent = 'Error';
                document.getElementById('totalHoursCount').textContent = 'Error';
                document.getElementById('activeDriversCount').textContent = 'Error';
            }
        }

        // Initialize analytics when reports tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Add analytics initialization to the existing tab switching logic
            const originalShowTab = window.showTab;
            window.showTab = function(tabName) {
                originalShowTab(tabName);
                
                if (tabName === 'reports') {
                    // Initialize analytics if not already done
                    if (!document.getElementById('totalShiftsCount').textContent || document.getElementById('totalShiftsCount').textContent === '-') {
                        setTimeout(() => {
                            initializeAnalyticsDashboard();
                        }, 100);
                    }
                }
            };
        });
        // ====================================
        // LEAVE MANAGEMENT FUNCTIONS (STORY 15)
        // ====================================

        // Leave management state
        let currentLeaveFilters = {
            status: 'all',
            startDate: null,
            endDate: null,
            page: 1,
            limit: 10
        };

        // Load leave management data when tab is activated
        async function loadLeaveManagement() {
            console.log('[Leave Management] Loading leave management data');
            await Promise.all([
                loadLeaveRequests(),
                loadLeaveSummary()
            ]);
        }

        // Load leave requests with current filters
        async function loadLeaveRequests() {
            console.log('[Leave Management] Loading leave requests with filters:', currentLeaveFilters);
            
            try {
                const queryParams = new URLSearchParams({
                    status: currentLeaveFilters.status,
                    page: currentLeaveFilters.page,
                    limit: currentLeaveFilters.limit
                });

                if (currentLeaveFilters.startDate) {
                    queryParams.append('startDate', currentLeaveFilters.startDate);
                }
                if (currentLeaveFilters.endDate) {
                    queryParams.append('endDate', currentLeaveFilters.endDate);
                }

                const response = await fetch(`/api/admin/leave-requests?${queryParams}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    displayLeaveRequests(result.data.leaveRequests);
                    displayLeavePagination(result.data.pagination);
                    console.log('[Leave Management] Loaded', result.data.leaveRequests.length, 'leave requests');
                } else {
                    throw new Error(result.message || 'Failed to load leave requests');
                }
            } catch (error) {
                console.error('[Leave Management] Error loading leave requests:', error);
                document.getElementById('leave-requests-tbody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">
                            ❌ Error loading leave requests: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Load leave summary statistics
        async function loadLeaveSummary() {
            try {
                const response = await fetch('/api/admin/leave-requests?summary=true', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    updateLeaveSummaryCards(result.data.summary);
                    console.log('[Leave Management] Summary loaded:', result.data.summary);
                } else {
                    throw new Error(result.message || 'Failed to load leave summary');
                }
            } catch (error) {
                console.error('[Leave Management] Error loading leave summary:', error);
            }
        }

        // Display leave requests in table
        function displayLeaveRequests(leaveRequests) {
            const tbody = document.getElementById('leave-requests-tbody');
            
            if (!leaveRequests || leaveRequests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            📋 No leave requests found
                        </td>
                    </tr>
                `;
                return;
            }

            const tableHtml = leaveRequests.map(request => {
                const statusBadge = getStatusBadge(request.status);
                const leaveDate = formatDate(request.leaveDate);
                const requestedDate = formatDateTime(request.requestedAt);
                const actions = getLeaveActions(request);

                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">
                            <strong>${request.driverName}</strong><br>
                            <small>${request.driverPhone}</small>
                        </td>
                        <td style="padding: 12px;">${leaveDate}</td>
                        <td style="padding: 12px;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${getTypeColor(request.leaveType)};">
                                ${request.leaveType.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 12px; max-width: 200px;">
                            <div style="overflow: hidden; text-overflow: ellipsis;" title="${request.reason}">
                                ${request.reason}
                            </div>
                        </td>
                        <td style="padding: 12px;">${statusBadge}</td>
                        <td style="padding: 12px;">
                            <small>${requestedDate}</small>
                        </td>
                        <td style="padding: 12px;">${actions}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = tableHtml;
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                pending: '<span style="padding: 4px 8px; border-radius: 4px; background: #fff3cd; color: #856404;">⏳ PENDING</span>',
                approved: '<span style="padding: 4px 8px; border-radius: 4px; background: #d4edda; color: #155724;">✅ APPROVED</span>',
                rejected: '<span style="padding: 4px 8px; border-radius: 4px; background: #f8d7da; color: #721c24;">❌ REJECTED</span>',
                cancelled: '<span style="padding: 4px 8px; border-radius: 4px; background: #e2e3e5; color: #383d41;">🚫 CANCELLED</span>'
            };
            return badges[status] || status;
        }

        // Get leave type color
        function getTypeColor(type) {
            const colors = {
                annual: '#e7f3ff',
                sick: '#fff2e7', 
                emergency: '#ffe7e7'
            };
            return colors[type] || '#f8f9fa';
        }

        // Get leave actions HTML
        function getLeaveActions(request) {
            if (request.status === 'pending') {
                return `
                    <button onclick="approveLeaveRequest(${request.id})" 
                            style="padding: 4px 8px; margin-right: 4px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ✅ Approve
                    </button>
                    <button onclick="rejectLeaveRequest(${request.id})" 
                            style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ❌ Reject
                    </button>
                `;
            } else {
                return `<small style="color: #666;">No actions</small>`;
            }
        }

        // Update leave summary cards
        function updateLeaveSummaryCards(summary) {
            document.getElementById('total-requests').textContent = summary.totalRequests || 0;
            document.getElementById('pending-requests').textContent = summary.pendingRequests || 0;
            document.getElementById('approved-requests').textContent = summary.approvedRequests || 0;
            document.getElementById('rejected-requests').textContent = summary.rejectedRequests || 0;
        }

        // Display leave pagination
        function displayLeavePagination(pagination) {
            const container = document.getElementById('leave-pagination');
            const pageInfo = document.getElementById('leave-page-info');
            const prevBtn = document.getElementById('leave-prev');
            const nextBtn = document.getElementById('leave-next');

            if (pagination.totalPages <= 1) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            pageInfo.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages} (${pagination.totalRequests} total)`;
            
            prevBtn.disabled = pagination.currentPage <= 1;
            nextBtn.disabled = pagination.currentPage >= pagination.totalPages;

            prevBtn.onclick = () => {
                if (currentLeaveFilters.page > 1) {
                    currentLeaveFilters.page--;
                    loadLeaveRequests();
                }
            };

            nextBtn.onclick = () => {
                if (currentLeaveFilters.page < pagination.totalPages) {
                    currentLeaveFilters.page++;
                    loadLeaveRequests();
                }
            };
        }

        // Apply leave filters
        async function applyLeaveFilters() {
            currentLeaveFilters.status = document.getElementById('leave-status-filter').value;
            currentLeaveFilters.startDate = document.getElementById('leave-start-date').value || null;
            currentLeaveFilters.endDate = document.getElementById('leave-end-date').value || null;
            currentLeaveFilters.page = 1; // Reset to first page

            console.log('[Leave Management] Applying filters:', currentLeaveFilters);
            await loadLeaveRequests();
        }

        // Clear leave filters
        async function clearLeaveFilters() {
            document.getElementById('leave-status-filter').value = 'all';
            document.getElementById('leave-start-date').value = '';
            document.getElementById('leave-end-date').value = '';
            
            currentLeaveFilters = {
                status: 'all',
                startDate: null,
                endDate: null,
                page: 1,
                limit: 10
            };

            console.log('[Leave Management] Filters cleared');
            await loadLeaveRequests();
        }

        // Refresh leave data
        async function refreshLeaveData() {
            console.log('[Leave Management] Refreshing data');
            await loadLeaveManagement();
        }

        // Approve leave request
        async function approveLeaveRequest(leaveRequestId) {
            const notes = prompt('Add approval notes (optional):');
            if (notes === null) return; // User cancelled

            try {
                const response = await fetch(`/api/admin/leave-requests/${leaveRequestId}/approve`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: notes || '' })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(`Leave request approved successfully!`, 'success');
                    await loadLeaveManagement(); // Refresh data
                } else {
                    throw new Error(result.message || 'Failed to approve leave request');
                }
            } catch (error) {
                console.error('[Leave Management] Error approving leave:', error);
                showAlert(`Failed to approve leave request: ${error.message}`, 'error');
            }
        }

        // Reject leave request
        async function rejectLeaveRequest(leaveRequestId) {
            const notes = prompt('Add rejection reason (required):');
            if (!notes || notes.trim() === '') {
                showAlert('Rejection reason is required', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/admin/leave-requests/${leaveRequestId}/reject`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: notes })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(`Leave request rejected`, 'success');
                    await loadLeaveManagement(); // Refresh data
                } else {
                    throw new Error(result.message || 'Failed to reject leave request');
                }
            } catch (error) {
                console.error('[Leave Management] Error rejecting leave:', error);
                showAlert(`Failed to reject leave request: ${error.message}`, 'error');
            }
        }

        // Format date helper
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Format datetime helper
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Enhanced showTab function to handle leave management and shift management
        const originalShowTab = window.showTab;
        window.showTab = function(tabName) {
            originalShowTab(tabName);
            
            if (tabName === 'leave') {
                // Initialize leave management if not already done
                if (document.getElementById('total-requests').textContent === '-') {
                    setTimeout(() => {
                        loadLeaveManagement();
                    }, 100);
                }
            } else if (tabName === 'advance') {
                // Initialize advance payment management if not already done
                setTimeout(() => {
                    initializeAdvancePayment();
                }, 100);
            } else if (tabName === 'shifts') {
                // Initialize shift management if not already done
                setTimeout(() => {
                    loadShiftManagement();
                }, 100);
            } else if (tabName === 'reports') {
                // Initialize analytics if not already done
                if (!document.getElementById('totalShiftsCount').textContent || document.getElementById('totalShiftsCount').textContent === '-') {
                    setTimeout(() => {
                        initializeAnalyticsDashboard();
                    }, 100);
                }
            }
        };

    </script>
    
    <!-- Translation System -->
    <script type="module" src="js/translationManager.js"></script>
    <script>
        // Initialize language change for admin panel
        window.addEventListener('languageChanged', function(event) {
            console.log('[Admin Panel] Language changed to:', event.detail.language);
            
            // Update document language attribute
            document.documentElement.setAttribute('lang', event.detail.language);
            document.documentElement.setAttribute('data-language', event.detail.language);
            
            // Refresh dynamic content translations if needed
            if (typeof loadLeaveManagement === 'function') {
                // Refresh leave management to apply translations
                setTimeout(() => loadLeaveManagement(), 100);
            }
        });
        
        // Wait for translation system to be ready
        window.addEventListener('translationSystemReady', function(event) {
            console.log('[Admin Panel] Translation system ready');
            
            // Apply initial language setting
            document.documentElement.setAttribute('data-language', event.detail.language);
            
            // Initialize content that might need translations
            setTimeout(() => {
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab && activeTab.onclick) {
                    // Re-trigger active tab to apply translations
                    activeTab.click();
                }
            }, 200);
        });

        // Story 17: Manual Shift Management Functions
        let shiftData = {
            shifts: [],
            currentPage: 1,
            totalPages: 1,
            totalShifts: 0,
            limit: 20
        };
        let currentShift = null;

        // Load shift management data
        async function loadShiftManagement() {
            console.log('[Shift Management] Loading shift data...');
            try {
                // Load drivers for filter dropdown
                await loadDriversForFilter();
                
                // Load shifts
                await loadShifts();
                
            } catch (error) {
                console.error('[Shift Management] Error loading data:', error);
                showAlert('Failed to load shift management data', 'error');
            }
        }

        // Load drivers for filter dropdown
        async function loadDriversForFilter() {
            try {
                const response = await fetch('/api/admin/drivers', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success && result.data) {
                    const filterSelect = document.getElementById('shift-driver-filter');
                    const modalSelect = document.getElementById('shift-driver-select');
                    
                    // Clear existing options (keep "All Drivers" for filter)
                    filterSelect.innerHTML = '<option value="all">All Drivers</option>';
                    modalSelect.innerHTML = '<option value="">Select Driver</option>';
                    
                    // Add driver options
                    result.data.forEach(driver => {
                        filterSelect.innerHTML += `<option value="${driver.id}">${driver.name} (${driver.phone})</option>`;
                        modalSelect.innerHTML += `<option value="${driver.id}">${driver.name} (${driver.phone})</option>`;
                    });
                    
                    console.log('[Shift Management] Loaded', result.data.length, 'drivers for selection');
                } else {
                    console.error('[Shift Management] Invalid driver data response:', result);
                }
            } catch (error) {
                console.error('[Shift Management] Error loading drivers:', error);
            }
        }

        // Load shifts
        async function loadShifts(page = 1) {
            try {
                const driverFilter = document.getElementById('shift-driver-filter')?.value || 'all';
                const statusFilter = document.getElementById('shift-status-filter')?.value || 'all';
                const dateFilter = document.getElementById('shift-date-filter')?.value || '';
                
                let url = `/api/admin/shifts?page=${page}&limit=${shiftData.limit}`;
                if (driverFilter !== 'all') url += `&driver_id=${driverFilter}`;
                if (statusFilter !== 'all') url += `&status=${statusFilter}`;
                if (dateFilter) url += `&date=${dateFilter}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    shiftData = {
                        shifts: result.data.shifts || [],
                        currentPage: result.data.pagination.currentPage,
                        totalPages: result.data.pagination.totalPages,
                        totalShifts: result.data.pagination.totalShifts,
                        limit: result.data.pagination.limit
                    };
                    
                    renderShiftsTable();
                    updateShiftsPagination();
                    
                    console.log('[Shift Management] Loaded', shiftData.shifts.length, 'shifts');
                } else {
                    throw new Error(result.error || 'Failed to load shifts');
                }
            } catch (error) {
                console.error('[Shift Management] Error loading shifts:', error);
                document.getElementById('shifts-tbody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #dc3545;">
                            ❌ Failed to load shifts: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Render shifts table
        function renderShiftsTable() {
            const tbody = document.getElementById('shifts-tbody');
            
            if (shiftData.shifts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            📋 No shifts found matching your criteria
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = shiftData.shifts.map(shift => {
                const duration = shift.duration_minutes ? `${Math.floor(shift.duration_minutes / 60)}h ${shift.duration_minutes % 60}m` : '-';
                const distance = shift.total_distance ? `${shift.total_distance} km` : '-';
                const statusBadge = shift.status === 'active' 
                    ? '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Active</span>'
                    : '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Completed</span>';
                
                return `
                    <tr>
                        <td style="padding: 12px; font-weight: 500;">${shift.driver_name}</td>
                        <td style="padding: 12px;">${shift.clock_in_time || '-'}</td>
                        <td style="padding: 12px;">${shift.clock_out_time || '-'}</td>
                        <td style="padding: 12px;">${duration}</td>
                        <td style="padding: 12px;">${distance}</td>
                        <td style="padding: 12px;">${statusBadge}</td>
                        <td style="padding: 12px;">
                            <button onclick="editShift(${shift.id})" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">Edit</button>
                            <button onclick="deleteShift(${shift.id})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update shifts pagination
        function updateShiftsPagination() {
            const paginationContainer = document.getElementById('shifts-pagination');
            const pageInfo = document.getElementById('shifts-page-info');
            const prevBtn = document.getElementById('shifts-prev');
            const nextBtn = document.getElementById('shifts-next');

            if (shiftData.totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';
            pageInfo.textContent = `Page ${shiftData.currentPage} of ${shiftData.totalPages} (${shiftData.totalShifts} total shifts)`;
            
            prevBtn.disabled = shiftData.currentPage <= 1;
            nextBtn.disabled = shiftData.currentPage >= shiftData.totalPages;
            
            prevBtn.onclick = () => {
                if (shiftData.currentPage > 1) {
                    loadShifts(shiftData.currentPage - 1);
                }
            };
            
            nextBtn.onclick = () => {
                if (shiftData.currentPage < shiftData.totalPages) {
                    loadShifts(shiftData.currentPage + 1);
                }
            };
        }

        // Show create shift modal
        function showCreateShiftModal() {
            currentShift = null;
            document.getElementById('modal-title').textContent = 'Create New Shift';
            document.getElementById('shift-submit-btn').textContent = 'Create Shift';
            document.getElementById('shift-form').reset();
            document.getElementById('shift-modal').style.display = 'flex';
        }

        // Show edit shift modal
        async function editShift(shiftId) {
            try {
                const response = await fetch(`/api/admin/shifts/${shiftId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    currentShift = result.data;
                    
                    // Populate form with shift data
                    document.getElementById('modal-title').textContent = 'Edit Shift';
                    document.getElementById('shift-submit-btn').textContent = 'Update Shift';
                    document.getElementById('shift-driver-select').value = currentShift.driver_id;
                    document.getElementById('shift-clock-in').value = formatDateTimeForInput(currentShift.clock_in_time);
                    document.getElementById('shift-clock-out').value = currentShift.clock_out_time ? formatDateTimeForInput(currentShift.clock_out_time) : '';
                    document.getElementById('shift-start-odo').value = currentShift.start_odometer;
                    document.getElementById('shift-end-odo').value = currentShift.end_odometer || '';
                    document.getElementById('shift-notes').value = currentShift.notes || '';
                    
                    document.getElementById('shift-modal').style.display = 'flex';
                } else {
                    throw new Error(result.error || 'Failed to load shift details');
                }
            } catch (error) {
                console.error('[Shift Management] Error loading shift for edit:', error);
                showAlert('Failed to load shift details for editing', 'error');
            }
        }

        // Delete shift
        async function deleteShift(shiftId) {
            if (!confirm('Are you sure you want to delete this shift? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/shifts/${shiftId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    showAlert('Shift deleted successfully', 'success');
                    loadShifts(shiftData.currentPage);
                } else {
                    throw new Error(result.error || 'Failed to delete shift');
                }
            } catch (error) {
                console.error('[Shift Management] Error deleting shift:', error);
                showAlert('Failed to delete shift: ' + error.message, 'error');
            }
        }

        // Close shift modal
        function closeShiftModal() {
            document.getElementById('shift-modal').style.display = 'none';
            currentShift = null;
        }

        // Handle shift form submission
        document.getElementById('shift-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                driver_id: document.getElementById('shift-driver-select').value,
                clock_in_time: document.getElementById('shift-clock-in').value,
                clock_out_time: document.getElementById('shift-clock-out').value || null,
                start_odometer: parseInt(document.getElementById('shift-start-odo').value),
                end_odometer: document.getElementById('shift-end-odo').value ? parseInt(document.getElementById('shift-end-odo').value) : null,
                notes: document.getElementById('shift-notes').value
            };

            // Validation
            if (!formData.driver_id) {
                showAlert('Please select a driver', 'error');
                return;
            }

            if (!formData.notes || formData.notes.trim().length === 0) {
                showAlert('Notes are required for manual shift management', 'error');
                document.getElementById('shift-notes').focus();
                return;
            }

            if (formData.end_odometer && formData.end_odometer < formData.start_odometer) {
                showAlert('End odometer cannot be less than start odometer', 'error');
                return;
            }

            try {
                const url = currentShift ? `/api/admin/shifts/${currentShift.id}` : '/api/admin/shifts';
                const method = currentShift ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    showAlert(`Shift ${currentShift ? 'updated' : 'created'} successfully`, 'success');
                    closeShiftModal();
                    loadShifts(shiftData.currentPage);
                } else {
                    throw new Error(result.error || `Failed to ${currentShift ? 'update' : 'create'} shift`);
                }
            } catch (error) {
                console.error('[Shift Management] Error saving shift:', error);
                showAlert(`Failed to ${currentShift ? 'update' : 'create'} shift: ` + error.message, 'error');
            }
        });

        // Filter functions
        function applyShiftFilters() {
            loadShifts(1); // Reset to first page when applying filters
        }

        function clearShiftFilters() {
            document.getElementById('shift-driver-filter').value = 'all';
            document.getElementById('shift-status-filter').value = 'all';
            document.getElementById('shift-date-filter').value = '';
            loadShifts(1);
        }

        function refreshShiftData() {
            loadShifts(shiftData.currentPage);
        }

        // Utility function to format datetime for input field
        function formatDateTimeForInput(dateTimeString) {
            if (!dateTimeString) return '';
            
            const date = new Date(dateTimeString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // PDF Export Functions (Story 18: PDF Payroll Reports)
        
        // Show PDF export status
        function showPDFStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('pdf-export-status');
            const statusText = document.getElementById('pdf-status-text');
            
            statusText.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.borderColor = '#c3e6cb';
                statusDiv.style.color = '#155724';
                statusDiv.querySelector('.loading-spinner').style.display = 'none';
            } else if (type === 'error') {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.borderColor = '#f5c6cb';
                statusDiv.style.color = '#721c24';
                statusDiv.querySelector('.loading-spinner').style.display = 'none';
            } else {
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.borderColor = '#ffeaa7';
                statusDiv.style.color = '#856404';
                statusDiv.querySelector('.loading-spinner').style.display = 'inline-block';
            }
            
            // Auto-hide success/error messages after 5 seconds
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Generate Monthly PDF Report
        async function generateMonthlyPDF() {
            const year = document.getElementById('monthly-year').value;
            const month = document.getElementById('monthly-month').value;
            
            if (!year || !month) {
                showAlert('Please select both year and month', 'error');
                return;
            }
            
            showPDFStatus('Generating monthly payroll PDF report...', 'loading');
            
            try {
                const response = await fetch(`/api/admin/payroll/${year}/${month}/export?download=true`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/html')) {
                    // HTML fallback - open in new window
                    const htmlContent = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();
                    showPDFStatus('Report opened in new window (HTML format)', 'success');
                } else {
                    // PDF download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Payroll_Report_${getMonthName(month)}_${year}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showPDFStatus('PDF report downloaded successfully', 'success');
                }
                
            } catch (error) {
                console.error('[PDF Export] Error generating monthly PDF:', error);
                showPDFStatus(`Failed to generate report: ${error.message}`, 'error');
            }
        }
        
        // Preview Monthly Report
        async function previewMonthlyReport() {
            const year = document.getElementById('monthly-year').value;
            const month = document.getElementById('monthly-month').value;
            
            if (!year || !month) {
                showAlert('Please select both year and month', 'error');
                return;
            }
            
            showPDFStatus('Loading report preview...', 'loading');
            
            try {
                const response = await fetch(`/api/admin/payroll/${year}/${month}/export?download=false`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const htmlContent = await response.text();
                const newWindow = window.open('', '_blank');
                newWindow.document.write(htmlContent);
                newWindow.document.close();
                showPDFStatus('Report preview opened in new window', 'success');
                
            } catch (error) {
                console.error('[PDF Export] Error previewing monthly report:', error);
                showPDFStatus(`Failed to preview report: ${error.message}`, 'error');
            }
        }
        
        // Generate Year-to-Date PDF Report
        async function generateYTDPDF() {
            const year = document.getElementById('ytd-year').value;
            
            if (!year) {
                showAlert('Please select a year', 'error');
                return;
            }
            
            showPDFStatus('Generating year-to-date payroll PDF report...', 'loading');
            
            try {
                const response = await fetch(`/api/admin/payroll/${year}/ytd/export?download=true`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/html')) {
                    // HTML fallback - open in new window
                    const htmlContent = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();
                    showPDFStatus('YTD report opened in new window (HTML format)', 'success');
                } else {
                    // PDF download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `YTD_Payroll_Report_${year}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showPDFStatus('YTD PDF report downloaded successfully', 'success');
                }
                
            } catch (error) {
                console.error('[PDF Export] Error generating YTD PDF:', error);
                showPDFStatus(`Failed to generate YTD report: ${error.message}`, 'error');
            }
        }
        
        // Preview Year-to-Date Report
        async function previewYTDReport() {
            const year = document.getElementById('ytd-year').value;
            
            if (!year) {
                showAlert('Please select a year', 'error');
                return;
            }
            
            showPDFStatus('Loading YTD report preview...', 'loading');
            
            try {
                const response = await fetch(`/api/admin/payroll/${year}/ytd/export?download=false`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const htmlContent = await response.text();
                const newWindow = window.open('', '_blank');
                newWindow.document.write(htmlContent);
                newWindow.document.close();
                showPDFStatus('YTD report preview opened in new window', 'success');
                
            } catch (error) {
                console.error('[PDF Export] Error previewing YTD report:', error);
                showPDFStatus(`Failed to preview YTD report: ${error.message}`, 'error');
            }
        }
        
        // Helper function to get month name
        function getMonthName(monthNumber) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return months[parseInt(monthNumber) - 1] || 'Unknown';
        }

        // Story 19: Advance Payment Configuration Functions
        async function loadAdvanceConfig() {
            try {
                console.log('[Admin Advance Config] Loading configuration...');
                
                const response = await fetch('/api/admin/advance-config', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    const config = result.data;
                    
                    // Update display with current configuration
                    document.getElementById('current-advance-percent').textContent = config.maxAdvancePercent || 60;
                    document.getElementById('current-monthly-requests').textContent = config.maxMonthlyRequests || 3;
                    document.getElementById('current-min-amount').textContent = (config.minAdvanceAmount || 500).toLocaleString();
                    document.getElementById('current-max-amount').textContent = (config.maxAdvanceAmount || 20000).toLocaleString();
                    document.getElementById('current-eligibility-months').textContent = config.eligibilityMonths || 3;
                    document.getElementById('config-last-updated').textContent = config.updatedAt || config.createdAt || '-';
                    
                    console.log('[Admin Advance Config] Configuration loaded successfully');
                } else {
                    throw new Error(result.message || 'Failed to load configuration');
                }
            } catch (error) {
                console.error('[Admin Advance Config] Error loading configuration:', error);
                // Show default values if loading fails
                document.getElementById('current-advance-percent').textContent = '60';
                document.getElementById('current-monthly-requests').textContent = '3';
                document.getElementById('current-min-amount').textContent = '500';
                document.getElementById('current-max-amount').textContent = '20,000';
                document.getElementById('current-eligibility-months').textContent = '3';
                document.getElementById('config-last-updated').textContent = 'Error loading';
            }
        }

        function showConfigEditForm() {
            // Get current values for the form
            const currentPercent = document.getElementById('current-advance-percent').textContent;
            const currentRequests = document.getElementById('current-monthly-requests').textContent;
            const currentMinAmount = parseInt(document.getElementById('current-min-amount').textContent.replace(/,/g, ''));
            const currentMaxAmount = parseInt(document.getElementById('current-max-amount').textContent.replace(/,/g, ''));
            const currentEligibilityMonths = document.getElementById('current-eligibility-months').textContent;

            // Populate form with current values
            document.getElementById('config-advance-percent').value = currentPercent;
            document.getElementById('config-monthly-requests').value = currentRequests;
            document.getElementById('config-min-amount').value = currentMinAmount;
            document.getElementById('config-max-amount').value = currentMaxAmount;
            document.getElementById('config-eligibility-months').value = currentEligibilityMonths;

            // Show form and hide button
            document.getElementById('advance-config-form').style.display = 'block';
            document.getElementById('edit-config-btn').style.display = 'none';
        }

        function cancelConfigEdit() {
            // Hide form and show button
            document.getElementById('advance-config-form').style.display = 'none';
            document.getElementById('edit-config-btn').style.display = 'inline-block';
            
            // Clear form
            document.getElementById('advanceConfigForm').reset();
        }

        // Story 19: Advance Payment Management Functions
        let advanceRequestsData = [];
        let advanceCurrentPage = 1;
        let advanceItemsPerPage = 10;
        let advanceFilters = {};

        // Initialize Advance Payment Management
        async function initializeAdvancePayment() {
            console.log('[Advance Management] Initializing advance payment management...');
            await loadAdvanceRequestsSummary();
            await loadAdvanceRequestsList();
            await loadDriversForAdvanceFilter();
        }

        // Load advance requests summary
        async function loadAdvanceRequestsSummary() {
            try {
                console.log('[Advance Management] Loading summary...');
                
                const response = await fetch('/api/admin/advance-requests?summary=true', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('[Advance Management] Summary loaded:', result);

                if (result.success && result.data) {
                    displayAdvanceSummary(result.data);
                } else {
                    throw new Error(result.message || 'Failed to load summary');
                }

            } catch (error) {
                console.error('[Advance Management] Error loading summary:', error);
                showAlert(`Error loading advance summary: ${error.message}`, 'error');
            }
        }

        // Display advance payment summary
        function displayAdvanceSummary(data) {
            console.log('[Advance Management] Displaying summary for data:', data);
            
            // Use the requests array from data.requests or fallback to empty array
            const requests = (data && data.requests) ? data.requests : [];
            console.log('[Advance Management] Processing', requests.length, 'requests');
            
            // Calculate summary from requests
            const pendingRequests = requests.filter(r => r.status === 'pending');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const approvedThisMonth = requests.filter(r => {
                if (r.status !== 'approved') return false;
                const requestDate = new Date(r.requestDate || r.request_date);
                return requestDate.getMonth() === currentMonth && requestDate.getFullYear() === currentYear;
            });
            
            const outstandingRequests = requests.filter(r => r.status === 'approved' || r.status === 'paid');
            const totalOutstanding = outstandingRequests.reduce((sum, r) => {
                const amount = r.approvedAmount || r.approved_amount || r.requestedAmount || r.requested_amount || 0;
                return sum + (typeof amount === 'number' ? amount : 0);
            }, 0);
            
            const totalRequestAmount = requests.reduce((sum, r) => {
                const amount = r.requestedAmount || r.requested_amount || 0;
                return sum + (typeof amount === 'number' ? amount : 0);
            }, 0);
            
            const averageRequest = requests.length > 0 ? totalRequestAmount / requests.length : 0;

            // Update UI elements
            document.getElementById('pendingAdvancesCount').textContent = pendingRequests.length;
            document.getElementById('approvedAdvancesCount').textContent = approvedThisMonth.length;
            document.getElementById('totalOutstandingAmount').textContent = `₹${Math.round(totalOutstanding).toLocaleString('en-IN')}`;
            document.getElementById('averageRequestAmount').textContent = `₹${Math.round(averageRequest).toLocaleString('en-IN')}`;
            
            console.log('[Advance Management] Summary updated:', {
                pending: pendingRequests.length,
                approved: approvedThisMonth.length, 
                outstanding: totalOutstanding,
                average: averageRequest
            });
        }

        // Load advance requests list
        async function loadAdvanceRequestsList(page = 1) {
            try {
                console.log('[Advance Management] Loading requests list...');
                
                const params = new URLSearchParams({
                    page: page,
                    limit: advanceItemsPerPage,
                    ...advanceFilters
                });

                const response = await fetch(`/api/admin/advance-requests?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('[Advance Management] Requests loaded:', result);

                if (result.success && result.data) {
                    advanceRequestsData = result.data.requests || [];
                    displayAdvanceRequestsList(advanceRequestsData);
                    updateAdvancePagination(result.data.totalCount || 0, page);
                } else {
                    throw new Error(result.message || 'Failed to load requests');
                }

            } catch (error) {
                console.error('[Advance Management] Error loading requests:', error);
                const tbody = document.getElementById('advance-requests-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #d32f2f;">
                            Error loading advance requests: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Display advance requests list
        function displayAdvanceRequestsList(requests) {
            const tbody = document.getElementById('advance-requests-tbody');
            
            if (!requests || requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            No advance requests found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = requests.map(request => {
                console.log('[Advance Management] Processing request:', request);
                
                const statusBadge = getStatusBadge(request.status);
                const requestDate = formatDate(request.requestDate || request.request_date);
                const requestedAmount = request.requestedAmount || request.requested_amount || 0;
                const amount = `₹${requestedAmount.toLocaleString('en-IN')}`;
                
                let actions = '';
                if (request.status === 'pending') {
                    actions = `
                        <button onclick="showApprovalModal(${request.id})" 
                                style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            ✓ Approve
                        </button>
                        <button onclick="showRejectionModal(${request.id})" 
                                style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ✗ Reject
                        </button>
                    `;
                } else if (request.status === 'approved') {
                    actions = `
                        <button onclick="markAsPaid(${request.id})" 
                                style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            💰 Mark Paid
                        </button>
                    `;
                } else {
                    actions = `<span style="color: #666; font-style: italic;">No actions</span>`;
                }

                const driverName = request.driverName || request.driver_name || 'Unknown';
                const advanceType = request.advanceType || request.advance_type || 'Regular';
                const reason = request.reason || 'No reason provided';

                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; font-weight: 500;">${driverName}</td>
                        <td style="padding: 12px; font-weight: 600; color: #2c5aa0;">${amount}</td>
                        <td style="padding: 12px;">
                            <span style="padding: 4px 8px; background: #e9ecef; border-radius: 4px; font-size: 0.85em; text-transform: capitalize;">
                                ${advanceType}
                            </span>
                        </td>
                        <td style="padding: 12px; color: #666;">${requestDate}</td>
                        <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${reason}">
                            ${reason}
                        </td>
                        <td style="padding: 12px;">${statusBadge}</td>
                        <td style="padding: 12px;">${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        // Get status badge
        function getStatusBadge(status) {
            const statusColors = {
                'pending': { bg: '#fff3cd', color: '#856404', text: 'Pending' },
                'approved': { bg: '#d4edda', color: '#155724', text: 'Approved' },
                'rejected': { bg: '#f8d7da', color: '#721c24', text: 'Rejected' },
                'paid': { bg: '#d1ecf1', color: '#0c5460', text: 'Paid' }
            };
            
            const config = statusColors[status] || { bg: '#f8f9fa', color: '#495057', text: status };
            
            return `
                <span style="padding: 6px 12px; background: ${config.bg}; color: ${config.color}; 
                             border-radius: 20px; font-size: 0.85em; font-weight: 500;">
                    ${config.text}
                </span>
            `;
        }

        // Update advance pagination
        function updateAdvancePagination(totalCount, currentPage) {
            const pagination = document.getElementById('advance-pagination');
            const pageInfo = document.getElementById('advance-page-info');
            const prevBtn = document.getElementById('advance-prev');
            const nextBtn = document.getElementById('advance-next');

            const totalPages = Math.ceil(totalCount / advanceItemsPerPage);
            const startItem = (currentPage - 1) * advanceItemsPerPage + 1;
            const endItem = Math.min(currentPage * advanceItemsPerPage, totalCount);

            pageInfo.textContent = `Showing ${startItem}-${endItem} of ${totalCount} requests`;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    advanceCurrentPage = currentPage - 1;
                    loadAdvanceRequestsList(advanceCurrentPage);
                }
            };
            
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    advanceCurrentPage = currentPage + 1;
                    loadAdvanceRequestsList(advanceCurrentPage);
                }
            };

            pagination.style.display = totalCount > 0 ? 'flex' : 'none';
        }

        // Load drivers for filter dropdown
        async function loadDriversForAdvanceFilter() {
            try {
                const response = await fetch('/api/admin/drivers', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('[Advance Management] Drivers API response:', result);
                    
                    let drivers = [];
                    
                    // Handle different response structures
                    if (result.success && result.data && result.data.drivers) {
                        drivers = Array.isArray(result.data.drivers) ? result.data.drivers : [result.data.drivers];
                    } else if (result.success && result.data) {
                        drivers = Array.isArray(result.data) ? result.data : [result.data];
                    } else if (Array.isArray(result)) {
                        drivers = result;
                    } else if (result.drivers) {
                        drivers = Array.isArray(result.drivers) ? result.drivers : [result.drivers];
                    }
                    
                    const select = document.getElementById('advance-driver-filter');
                    select.innerHTML = '<option value="all">All Drivers</option>';
                    
                    if (drivers.length > 0) {
                        drivers.forEach(driver => {
                            const driverId = driver.id || driver.driver_id;
                            const driverName = driver.name || driver.driver_name || `Driver ${driverId}`;
                            select.innerHTML += `<option value="${driverId}">${driverName}</option>`;
                        });
                        console.log('[Advance Management] Loaded', drivers.length, 'drivers for filter');
                    } else {
                        console.log('[Advance Management] No drivers found in response');
                    }
                } else {
                    console.error('[Advance Management] Failed to load drivers:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('[Advance Management] Error loading drivers:', error);
                
                // Fallback: Load drivers from advance requests data
                if (advanceRequestsData && advanceRequestsData.length > 0) {
                    const select = document.getElementById('advance-driver-filter');
                    select.innerHTML = '<option value="all">All Drivers</option>';
                    
                    const uniqueDrivers = new Map();
                    advanceRequestsData.forEach(request => {
                        const driverId = request.driverId || request.driver_id;
                        const driverName = request.driverName || request.driver_name;
                        if (driverId && driverName) {
                            uniqueDrivers.set(driverId, driverName);
                        }
                    });
                    
                    uniqueDrivers.forEach((name, id) => {
                        select.innerHTML += `<option value="${id}">${name}</option>`;
                    });
                    
                    console.log('[Advance Management] Used fallback driver loading from requests data');
                }
            }
        }

        // Apply advance filters
        function applyAdvanceFilters() {
            advanceFilters = {};
            
            const status = document.getElementById('advance-status-filter').value;
            const driverId = document.getElementById('advance-driver-filter').value;
            const fromDate = document.getElementById('advance-from-date').value;
            const toDate = document.getElementById('advance-to-date').value;
            
            if (status !== 'all') advanceFilters.status = status;
            if (driverId !== 'all') advanceFilters.driverId = driverId;
            if (fromDate) advanceFilters.fromDate = fromDate;
            if (toDate) advanceFilters.toDate = toDate;
            
            advanceCurrentPage = 1;
            loadAdvanceRequestsList(1);
        }

        // Clear advance filters
        function clearAdvanceFilters() {
            document.getElementById('advance-status-filter').value = 'all';
            document.getElementById('advance-driver-filter').value = 'all';
            document.getElementById('advance-from-date').value = '';
            document.getElementById('advance-to-date').value = '';
            
            advanceFilters = {};
            advanceCurrentPage = 1;
            loadAdvanceRequestsList(1);
        }

        // Refresh advance data
        function refreshAdvanceData() {
            loadAdvanceRequestsSummary();
            loadAdvanceRequestsList(advanceCurrentPage);
        }

        // Show approval modal
        function showApprovalModal(advanceId) {
            const request = advanceRequestsData.find(r => r.id === advanceId);
            if (!request) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
                align-items: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #333;">Approve Advance Request</h3>
                    <div style="margin-bottom: 15px;">
                        <strong>Driver:</strong> ${request.driverName || request.driver_name || 'Unknown'}<br>
                        <strong>Requested Amount:</strong> ₹${(request.requestedAmount || request.requested_amount || 0).toLocaleString('en-IN')}<br>
                        <strong>Reason:</strong> ${request.reason || 'No reason provided'}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Approved Amount:</label>
                        <input type="number" id="approved-amount" value="${request.requestedAmount || request.requested_amount || 0}" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Payment Method:</label>
                        <select id="payment-method" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="cash">Cash</option>
                            <option value="cheque">Cheque</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes:</label>
                        <textarea id="approval-notes" rows="3" 
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                  placeholder="Optional approval notes..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="approveAdvanceRequest(${advanceId})" 
                                style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Approve
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // Approve advance request
        async function approveAdvanceRequest(advanceId) {
            try {
                const approvedAmount = parseFloat(document.getElementById('approved-amount').value);
                const paymentMethod = document.getElementById('payment-method').value;
                const notes = document.getElementById('approval-notes').value;

                if (!approvedAmount || approvedAmount <= 0) {
                    showAlert('Please enter a valid approved amount', 'error');
                    return;
                }

                const response = await fetch(`/api/admin/advance-request/${advanceId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        approvedAmount,
                        paymentMethod,
                        notes
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('✅ Advance request approved successfully!', 'success');
                    document.querySelector('[style*="position: fixed"]').remove(); // Close modal
                    refreshAdvanceData();
                } else {
                    throw new Error(result.message || 'Failed to approve request');
                }

            } catch (error) {
                console.error('[Advance Management] Error approving request:', error);
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        // Show rejection modal
        function showRejectionModal(advanceId) {
            const request = advanceRequestsData.find(r => r.id === advanceId);
            if (!request) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
                align-items: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #dc3545;">Reject Advance Request</h3>
                    <div style="margin-bottom: 15px;">
                        <strong>Driver:</strong> ${request.driverName || request.driver_name || 'Unknown'}<br>
                        <strong>Requested Amount:</strong> ₹${(request.requestedAmount || request.requested_amount || 0).toLocaleString('en-IN')}<br>
                        <strong>Reason:</strong> ${request.reason || 'No reason provided'}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Rejection Reason:</label>
                        <textarea id="rejection-reason" rows="3" required
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                  placeholder="Please provide a reason for rejection..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="rejectAdvanceRequest(${advanceId})" 
                                style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Reject
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // Reject advance request
        async function rejectAdvanceRequest(advanceId) {
            try {
                console.log('[Advance Management] Rejecting request:', advanceId);
                const rejectionReason = document.getElementById('rejection-reason').value.trim();

                if (!rejectionReason) {
                    showAlert('Please provide a reason for rejection', 'error');
                    return;
                }

                console.log('[Advance Management] Rejection reason:', rejectionReason);

                const response = await fetch(`/api/admin/advance-request/${advanceId}/reject`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        rejectionReason
                    })
                });

                const result = await response.json();
                console.log('[Advance Management] Rejection response:', result);

                if (result.success) {
                    showAlert('✅ Advance request rejected successfully!', 'success');
                    // Close modal properly
                    const modal = document.querySelector('[style*="position: fixed"]');
                    if (modal) modal.remove();
                    refreshAdvanceData();
                } else {
                    throw new Error(result.message || 'Failed to reject request');
                }

            } catch (error) {
                console.error('[Advance Management] Error rejecting request:', error);
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        // Mark advance as paid
        async function markAsPaid(advanceId) {
            if (!confirm('Mark this advance request as paid? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/advance-request/${advanceId}/mark-paid`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('✅ Advance marked as paid successfully!', 'success');
                    refreshAdvanceData();
                } else {
                    throw new Error(result.message || 'Failed to mark as paid');
                }

            } catch (error) {
                console.error('[Advance Management] Error marking as paid:', error);
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        // Format date helper
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        // Handle advance configuration form submission
        document.addEventListener('DOMContentLoaded', function() {
            const configForm = document.getElementById('advanceConfigForm');
            if (configForm) {
                configForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const submitBtn = document.getElementById('config-submit-btn');
                    const originalText = submitBtn.textContent;
                    
                    try {
                        // Disable submit button
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Updating...';
                        
                        // Get form data
                        const formData = {
                            maxAdvancePercent: parseInt(document.getElementById('config-advance-percent').value),
                            maxMonthlyRequests: parseInt(document.getElementById('config-monthly-requests').value),
                            minAdvanceAmount: parseInt(document.getElementById('config-min-amount').value),
                            maxAdvanceAmount: parseInt(document.getElementById('config-max-amount').value),
                            eligibilityMonths: parseInt(document.getElementById('config-eligibility-months').value),
                            notes: document.getElementById('config-notes').value.trim()
                        };

                        // Validate form data
                        if (formData.maxAdvanceAmount <= formData.minAdvanceAmount) {
                            throw new Error('Maximum amount must be greater than minimum amount');
                        }

                        if (!formData.notes) {
                            throw new Error('Change notes are required');
                        }

                        console.log('[Admin Advance Config] Updating configuration:', formData);

                        const response = await fetch('/api/admin/advance-config', {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const result = await response.json();
                        
                        if (result.success) {
                            // Hide form and reload configuration
                            cancelConfigEdit();
                            await loadAdvanceConfig();
                            
                            // Show success message
                            alert('Advance payment configuration updated successfully!');
                            console.log('[Admin Advance Config] Configuration updated successfully');
                        } else {
                            throw new Error(result.message || 'Failed to update configuration');
                        }
                        
                    } catch (error) {
                        console.error('[Admin Advance Config] Error updating configuration:', error);
                        alert(`Error updating configuration: ${error.message}`);
                    } finally {
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
        });

    </script>
</body>
</html>